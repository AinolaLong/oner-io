!function(){"use strict";function t(){this.reset()}var e="http://localhost:8010/";describe("nattyFetch v2.2.0 Unit Test",function(){describe("static",function(){it("version v2.2.0",function(){expect(nattyFetch.version).to.equal("2.2.0")})}),describe("global setting",function(){this.timeout(1e4);var t=nattyFetch.getGlobal(),o=["data","fit","header","ignoreSelfConcurrent","jsonp","log","method","mock","mockUrl","mockUrlPrefix","process","retry","timeout","url","urlPrefix","withCredentials","traditional"],r=(nattyFetch._event,function(){nattyFetch.setGlobal(t)});beforeEach(function(){r()}),afterEach(function(){var t;for(t in nattyFetch._event)0===t.indexOf("__")&&delete nattyFetch._event[t]}),it("check default global config properties: `nattyFetch.getGlobal()`",function(){o.forEach(function(e){expect(t).to.have.key(e)})}),it('check `nattyFetch.getGlobal("property")`',function(){expect(nattyFetch.getGlobal("jsonp")).to.be(!1)}),it("check `nattyFetch.setGlobal(obj)`",function(){nattyFetch.setGlobal({data:{_csrf_token:1}}),expect(nattyFetch.getGlobal("data")).to.eql({_csrf_token:1}),nattyFetch.setGlobal({data:{}})}),it("Context instance would inherit and extend the global config",function(){var t="http://test.com/api",e=nattyFetch.context({urlPrefix:t});expect(e._config.urlPrefix).to.be(t)}),it("Context instance would inherit and extend the global config 2",function(){var t="http://test.com/api";nattyFetch.setGlobal({urlPrefix:t});var e=nattyFetch.context();e.create("order",{create:{}}),expect(e.api.order.create.config.urlPrefix).to.be(t)}),it("catch error",function(t){nattyFetch.setGlobal({urlPrefix:e});var o=new nattyFetch.context;o.create("order",{create:{url:"api/order-create",method:"POST"}}),o.api.order.create().then(function(t){notExistedFn()}).catch(function(e){window.console?(console.log(e.message),console.error(e.stack)):C.log(e.message,e.stack),t()})}),it("check global `resolve`",function(t){nattyFetch.setGlobal({urlPrefix:e}),nattyFetch.on("resolve",function(e,o){try{expect(e.id).to.be(1),t()}catch(e){t(e)}});var o=nattyFetch.context();o.create("order",{create:{url:"api/order-create",method:"POST"}}),o.api.order.create().then(function(t){},function(){})}),it("check global `reject`",function(t){nattyFetch.setGlobal({urlPrefix:e}),nattyFetch.on("reject",function(e,o){try{expect(e.code).to.be(1),t()}catch(e){t(e)}});var o=nattyFetch.context();o.create("order",{create:{url:"api/return-error",method:"POST"}}),o.api.order.create().then(function(t){},function(){})}),it("check context `resolve`",function(t){var o=nattyFetch.context({urlPrefix:e});o.on("resolve",function(e,o){try{expect(e.id).to.be(1),t()}catch(e){t(e)}}),o.create("order",{create:{url:"api/order-create",method:"POST"}}),o.api.order.create().then(function(t){},function(){})}),it("check context `reject`",function(t){var o=nattyFetch.context({urlPrefix:e});o.on("reject",function(e,o){try{expect(e.code).to.be(1),t()}catch(e){t(e)}}),o.create("order",{create:{url:"api/return-error",method:"POST"}}),o.api.order.create().then(function(t){},function(){})}),it("check both global and context `resolve`",function(t){var o=!1;nattyFetch.setGlobal({urlPrefix:e}),nattyFetch.on("resolve",function(t){o=!0});var r=nattyFetch.context({});r.on("resolve",function(e){try{expect(o).to.be(!0),expect(e.id).to.be(1),t()}catch(e){t(e)}}),r.create("order",{create:{url:"api/order-create",method:"POST"}}),r.api.order.create().then(function(t){},function(){})}),it("check both global and context `reject`",function(t){var o=!1;nattyFetch.setGlobal({urlPrefix:e}),nattyFetch.on("reject",function(t){o=!0});var r=nattyFetch.context({urlPrefix:e});r.on("reject",function(e,r){try{expect(o).to.be(!0),expect(e.code).to.be(1),t()}catch(e){t(e)}}),r.create("order",{create:{url:"api/return-error",method:"POST"}}),r.api.order.create().then(function(t){},function(){})})}),describe("api config",function(){this.timeout(1e4);var t;beforeEach("reset NattyDB context",function(){t=nattyFetch.context({urlPrefix:e,jsonp:!0,mock:!1})}),it("both object and function can be used as api's config",function(){t.create("order",{pay:{},create:function(){return{}}}),expect(t.api.order).to.be.a("object"),expect(t.api.order.pay).to.be.a("function"),expect(t.api.order.create).to.be.a("function")}),it("`mock` option",function(){t.create("order",{pay:{mock:!0},create:{mock:!1},close:{}}),expect(t.api.order.pay.config.mock).to.be(!0),expect(t.api.order.create.config.mock).to.be(!1),expect(t.api.order.close.config.mock).to.be(!1)}),it("`mock` value from global",function(){var t=nattyFetch.context();t.create("order",{pay:{}}),expect(t.api.order.pay.config.mock).to.be(!1)}),it("`mockUrlPrefix` value from context",function(){var t=nattyFetch.context({mock:!0,mockUrlPrefix:"./mock/"});t.create("order",{pay:{mockUrl:"pay"},create:{mockUrl:"../create"},close:{mockUrl:"https://www.demo.com/close"}}),expect(t.api.order.pay.config.mockUrl).to.be("./mock/pay"),expect(t.api.order.create.config.mockUrl).to.be("../create"),expect(t.api.order.close.config.mockUrl).to.be("https://www.demo.com/close")}),it("`jsonp` option",function(){t.create("order",{pay:{url:"path"},transfer:{jsonp:!1,url:"path"},create:{url:"path.jsonp"},close:{url:"path.jsonp?foo"},delay:{mock:!0,mockUrl:"foo",jsonp:!1,url:"path.jsonp?foo"}}),expect(t.api.order.pay.config.jsonp).to.be(!0),expect(t.api.order.transfer.config.jsonp).to.be(!1),expect(t.api.order.create.config.jsonp).to.be(!0),expect(t.api.order.close.config.jsonp).to.be(!0),expect(t.api.order.delay.config.jsonp).to.be(!1)}),it("auto `urlPrefix`",function(){t.create("order",{method1:{url:"path"},method2:{url:"//foo.com/path"},method3:{url:"http://foo.com/path"},method4:{url:"https://foo.com/path"},method5:{url:"./path"},method6:{url:"../path"},method7:{url:"/path"}}),expect(t.api.order.method1.config.url).to.equal(e+"path"),expect(t.api.order.method2.config.url).to.be("//foo.com/path"),expect(t.api.order.method3.config.url).to.be("http://foo.com/path"),expect(t.api.order.method4.config.url).to.be("https://foo.com/path"),expect(t.api.order.method5.config.url).to.be("./path"),expect(t.api.order.method6.config.url).to.be("../path"),expect(t.api.order.method7.config.url).to.be("/path")})}),describe.skip("request config",function(){this.timeout(1e4);var t;beforeEach("reset",function(){t=nattyFetch.context()}),it("`request` config with success",function(e){var o=function(t){setTimeout(function(){t({id:1})},200)};t.create("order",{getSign:{data:{a:1},request:function(t,e,r){expect(t.data.a).to.be(1),expect(t.data.b).to.be(1),o(function(t){r.resolve(t)})}}}),t.api.order.getSign({b:1}).then(function(t){expect(t.id).to.be(1),e()})}),it("`request` config with error",function(e){var o=function(t,e){setTimeout(function(){e({message:1})},200)};t.create("order",{getSign:{request:function(t,e,r,c){o(function(t){r.resolve(t)},function(t){r.reject(t)})}}}),t.api.order.getSign().then(function(t){},function(t){expect(t.message).to.be(1),e()})}),it("`request` config with retry",function(e){var o=function(t,e){setTimeout(function(){e({message:1})},200)};t.create("order",{getSign:{retry:1,request:function(t,e,r,c){o(function(t){r.resolve(t)},function(t){r.reject(t)})}}}),t.api.order.getSign().then(function(t){},function(t){expect(t.message).to.be(1),e()})}),it("`request` config with ignoreSelfConcurrent",function(e){var o=0,r=function(t,e){o++,setTimeout(function(){e({message:1})},200)};t.create("order",{getSign:{ignoreSelfConcurrent:!0,request:function(t,e,o,c){r(function(t){o.resolve(t)},function(t){o.reject(t)})}}}),t.api.order.getSign().then(function(t){},function(t){expect(t.message).to.be(1)}),t.api.order.getSign().then(function(t){},function(t){}),setTimeout(function(){expect(o).to.be(1),e()},1e3)})}),describe("ajax",function(){this.timeout(1e4);var t;beforeEach("reset",function(){t=nattyFetch.context({urlPrefix:e,mock:!1})}),it("play with standard data structure",function(e){t.create("order",{create:{url:"api/order-create",method:"POST"}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),e()}catch(t){e(t)}})}),it("play with non-standard data structure by `fit`",function(o){t.create("order",{create:{url:e+"api/order-create-non-standard",method:"POST",fit:function(t){return{success:!t.hasError,content:t.content}}}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}})}),it("process data",function(o){t.create("order",{create:{url:e+"api/order-create",method:"POST",process:function(t){return{orderId:t.id}}}}),t.api.order.create().then(function(t){try{expect(t.orderId).to.be(1),o()}catch(t){o(t)}})}),it("`vars.data` in process or fix method",function(o){t.create("order",{create:{url:e+"api/order-create",method:"POST",data:{fixData:1},willFetch:function(t,e){t.data.hookData=1},process:function(t,e){return expect(e.data.fixData).to.be(1),expect(e.data.liveData).to.be(1),expect(e.data.hookData).to.be(1),{orderId:t.id}},fit:function(t,e){return expect(e.data.fixData).to.be(1),expect(e.data.liveData).to.be(1),expect(e.data.hookData).to.be(1),t}}}),t.api.order.create({liveData:1}).then(function(t){try{expect(t.orderId).to.be(1),o()}catch(t){o(t)}})}),it("skip process data when it is mocking ",function(o){t.create("order",{create:{mock:!0,mockUrl:e+"api/order-create",process:function(t){return this.mock?t:{orderId:t.id}}}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}})}),it("error by requesting cross-domain with disabled header [NOTE: IE的行为已被标准化]",function(o){t.create("order",{create:{url:e+"api/order-create",method:"POST",header:{foo:"foo"}}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t.message)}},function(t){})}),it("error by timeout",function(o){t.create("order",{create:{url:e+"api/timeout",method:"POST",timeout:100}}),t.api.order.create().then(function(){},function(t){try{expect(t.timeout).to.be(!0),o()}catch(t){o(t)}})}),it("pending status checking",function(o){t.create("order",{create:{url:e+"api/timeout",method:"POST",timeout:200}}),t.api.order.create().then(function(){},function(e){try{expect(t.api.order.create.pending).to.be(!1),o()}catch(t){o(t)}}),expect(t.api.order.create.pending).to.be(!0)}),it("error by 500",function(o){t.create("order",{create:{url:e+"api/500",method:"POST"}}),t.api.order.create().then(function(){},function(t){try{expect(t.status).to.be(nattyFetch.ajax.fallback?void 0:500),o()}catch(t){o(t)}})}),it("error by 404",function(o){t.create("order",{create:{url:e+"api/404",method:"POST"}}),t.on("reject",function(t){console.warn(t)}),t.api.order.create().then(function(){}).catch(function(t){try{nattyFetch.ajax.fallback?expect(t.status).to.be(void 0):expect(0===t.status||404===t.status).to.be(!0),o()}catch(t){o(t)}})}),it("`GET` resolving after retry",function(o){t.create("order",{create:{url:e+"api/retry-success",method:"GET",retry:2}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}},function(){})}),it("`GET` with fn-data resolving after retry",function(o){t.create("order",{create:{url:e+"api/retry-success",method:"GET",retry:2}});var r=0;t.api.order.create(function(){return{count:r++}}).then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}},function(){})}),it("`POST` resolving after retry",function(o){t.create("order",{create:{url:e+"api/retry-success",method:"POST",retry:2}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}},function(){})}),it("rejecting after retry",function(o){t.create("order",{create:{url:e+"api/return-error",retry:1}}),t.api.order.create().then(function(t){},function(t){try{expect(t.code).to.be(1),o()}catch(t){o(t)}})}),it("ignore seft concurrent",function(o){t.create("order",{create:{cache:!1,url:e+"api/timeout",ignoreSelfConcurrent:!0}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}});var r=t.api.order.create().then(function(){throw new Error("unexpected `resolved`")});expect(r).to.have.property("dummy"),expect(r.then()).to.be(r),expect(r.then().catch()).to.be(r)}),it("override seft concurrent(XHR)",function(o){t.create("order",{create:{cache:!1,url:e+"api/timeout",overrideSelfConcurrent:!0,process:function(t,e){expect(e.data.d).to.be(2)}}});var r=0;t.api.order.create({d:1}).then(function(t){r++}),setTimeout(function(){t.api.order.create({d:2}).then(function(t){try{expect(r).to.be(0),o()}catch(t){o(t)}})},300)}),it("override seft concurrent(JSONP)",function(o){t.create("order",{create:{cache:!1,jsonp:!0,url:e+"api/jsonp-timeout",overrideSelfConcurrent:!0,process:function(t,e){expect(e.data.d).to.be(2)}}});var r=0;t.api.order.create({d:1}).then(function(t){r++}),setTimeout(function(){t.api.order.create({d:2}).then(function(t){try{expect(r).to.be(0),o()}catch(t){o(t)}})},300)})}),describe("jsonp",function(){this.timeout(1e4);var t;beforeEach("reset",function(){t=nattyFetch.context({urlPrefix:e,mock:!1})}),it("check default jsonpCallbackQuery",function(){t.create("order",{create:{url:e+"api/order-create",jsonp:!0}}),expect(t.api.order.create.config.jsonpCallbackQuery).to.be(void 0)}),it("check custom jsonpCallbackQuery",function(){t.create("order",{create:{url:e+"api/order-create",jsonp:[!0,"cb","j{id}"]}}),expect(t.api.order.create.config.jsonp).to.be(!0),expect(t.api.order.create.config.jsonpFlag).to.be("cb"),expect(t.api.order.create.config.jsonpCallbackName).to.be("j{id}")}),it("auto detect jsonp option",function(){t.create("order",{create:{url:e+"api/order-create.jsonp"}}),expect(t.api.order.create.config.jsonp).to.be(!0)}),it("jsonp response.success is true",function(o){t.create("order",{create:{traditional:!0,data:{a:[1,2,3]},url:e+"api/jsonp-order-create",jsonp:!0}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}})}),it("jsonp response.success is false ",function(o){t.create("order",{create:{url:e+"api/jsonp-order-create-error",jsonp:!0}}),t.api.order.create().then(function(t){},function(t){try{expect(t).to.have.property("message"),o()}catch(t){o(t)}})}),it("jsonp with error url",function(o){t.create("order",{create:{url:e+"error-url",jsonp:!0}}),t.on("reject",function(t){console.warn(t)}),t.api.order.create().then(function(t){},function(t){try{expect(t.message).to.contain("Not Accessable JSONP"),o()}catch(t){o(t)}})}),it("jsonp timeout",function(o){t.create("order",{create:{url:e+"api/jsonp-timeout",jsonp:!0,timeout:300}}),t.api.order.create().then(function(){},function(t){try{expect(t.timeout).to.be(!0),o()}catch(t){o(t)}})}),it("`JSONP` resolving after retry",function(o){t.create("order",{create:{url:e+"api/jsonp-retry-success",jsonp:!0,retry:2}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}},function(){})}),it("rejecting after retry",function(o){t.create("order",{create:{url:e+"api/jsonp-error",jsonp:!0,retry:1}}),t.api.order.create().then(function(t){},function(t){try{expect(t.code).to.be(1),o()}catch(t){o(t)}})}),it("ignore self concurrent",function(o){t.create("order",{create:{url:e+"api/jsonp-timeout",jsonp:!0,ignoreSelfConcurrent:!0}}),t.api.order.create().then(function(t){try{expect(t.id).to.be(1),o()}catch(t){o(t)}});var r=t.api.order.create();expect(r).to.have.property("dummy"),expect(r.then()).to.be(r),expect(r.then().catch()).to.be(r)})})});var o=nattyFetch._util,r=o.appendQueryString,c=o.isAbsoluteUrl,n=o.isNumber,i=o.param,a=o.decodeParam,u=o.isIE,s=o.isCrossDomain,p=o.sortPlainObjectKey;describe("./util",function(){describe("param",function(){it("{a:'b c', d:['e+f',{g:'h', i:['j','k']}]}",function(){expect(a(i({a:"b c",d:["e+f",{g:"h",i:["j","k"]}],l:!0,m:0}))).to.be("a=b c&d[]=e+f&d[1][g]=h&d[1][i][]=j&d[1][i][]=k&l=true&m=0")}),it("{ id: function(){ return 1 + 2 } }",function(){expect(i({id:function(){return 3}})).to.be("id=3")}),it("param({ foo: 'bar', nested: { will: 'be ignored' }}, true)",function(){expect(a(i({foo:"bar",nested:{will:"be ignored"}},!0))).to.be("foo=bar&nested=[object Object]")}),it("param({ foo: [1, 2]}, true)",function(){expect(a(i({foo:[1,2]},!0))).to.be("foo=1&foo=2")}),it("param({ foo: [1, 2]})",function(){expect(a(i({foo:[1,2]}))).to.be("foo[]=1&foo[]=2")})}),describe("appendQueryString",function(){it("appendQueryString('./p', {})",function(){expect(r("./p",{})).to.be("./p")}),it("appendQueryString('./p', {foo:'foo'})",function(){expect(r("./p",{foo:"foo"})).to.be("./p?foo=foo")}),it("appendQueryString('./p?bar=bar', {foo:'foo'})",function(){expect(r("./p?bar=bar",{foo:"foo"})).to.be("./p?bar=bar&foo=foo")})}),describe("isAbsoluteUrl",function(){it("`https://path` should be a absolute url",function(){expect(c("https://path")).to.be(!0)}),it("`http://path` should be a absolute url",function(){expect(c("http://path")).to.be(!0)}),it("`//path` should be a absolute url",function(){expect(c("//path")).to.be(!0)}),it("`path//path` should not be a absolute url",function(){expect(c("foo//path")).to.be(!1)})}),describe("isNumber",function(){it("NaN",function(){expect(n(NaN)).to.be(!1)}),it("1",function(){expect(n(1)).to.be(!0)})}),describe("protocol",function(){it("location protocol",function(){var t=document.createElement("a");t.href=location.href,expect(t.protocol).to.be("http:")}),it("foo.json protocol (IE diff)",function(){var t=document.createElement("a");t.href="foo.json",expect(t.protocol).to.be(u?":":"http:")}),it("//www.foo.com/json protocol (IE diff)",function(){var t=document.createElement("a");t.href="//www.foo.com/json",expect(t.protocol).to.be(u?":":"http:")}),it("https://www.foo.com/json protocol",function(){var t=document.createElement("a");t.href="https://www.foo.com/json",expect(t.protocol).to.be("https:")})}),describe("hostname",function(){var t=document.createElement("a");t.href=location.href,it("location hostname",function(){var e=document.createElement("a");e.href=location.href,expect(e.hostname).to.be(t.hostname)}),it("foo.json hostname (IE diff)",function(){var e=document.createElement("a");e.href="foo.json",expect(e.hostname).to.be(u?"":t.hostname)}),it("//www.foo.com/json hostname",function(){var t=document.createElement("a");t.href="//www.foo.com/json",expect(t.hostname).to.be("www.foo.com")}),it("https://www.foo.com/json hostname",function(){var t=document.createElement("a");t.href="https://www.foo.com/json",expect(t.hostname).to.be("www.foo.com")})}),describe("isCrossDomain",function(){var t=document.createElement("a");t.href=location.href,it("foo.json",function(){expect(s("foo.json")).to.be(!1)}),it("../foo.json",function(){expect(s("../foo.json")).to.be(!1)}),it("www.foo.com/json",function(){expect(s("www.foo.com/json")).to.be(!1)}),it("//www.foo.com/json",function(){expect(s("//www.foo.com/json")).to.be(!0)}),it("absolute path",function(){expect(s(t.protocol+"//"+t.hostname+":"+t.port)).to.be(!1)}),it("different protocal",function(){expect(s("https://"+t.hostname)).to.be(!0)}),it("different port",function(){expect(s(t.protocol+"//"+t.hostname+":9876")).to.be(!0)}),it("https://www.foo.com/json",function(){expect(s("https://www.foo.com/json")).to.be(!0)})}),describe("isSameQueryStringFromObject",function(){var t=function(t,e){return JSON.stringify(p(t))===JSON.stringify(p(e))};it("turn to the same query string",function(){expect(t({c:"c",b:"b",a:{c:"c",a:"a"},d:["b","a"]},{b:"b",c:"c",d:["b","a"],a:{a:"a",c:"c"}})).to.be(!0)})})}),t.prototype.do=function(t){this.actualEvents.push(t)},t.prototype.count=function(){this.count++},t.prototype.expect=function(t){this.expectEvents=t},t.prototype.reset=function(){var t=this;t.expectEvents=[],t.actualEvents=[],t.count=0},t.prototype.check=function(){expect(this.actualEvents).to.eql(this.expectEvents)};var f=nattyFetch.ajax;describe("./ajax",function(){describe("dependent detects",function(){it("support `CORS`",function(){expect(nattyFetch.ajax.supportCORS).to.be(!0)})}),describe("browser detects：NOT used in nattyFetch",function(){var t=new XMLHttpRequest,e=["loadstart","load","progress","error","timeout"];e.forEach(function(e){it("support `"+e+"` event: "+("on"+e in t),function(){})}),it("support `CORS`: "+("withCredentials"in t),function(){})}),describe("post",function(){it("accept text",function(t){f({url:e+"api/return-text",method:"POST",data:{"return-text":1},success:function(e,o){expect(e).to.be("text"),t()}})}),it("accept json",function(t){f({url:e+"api/return-json",method:"POST",data:{"return-json":1},accept:"json",success:function(e,o){expect(e).to.eql({tool:"natty-fetch"}),t()}})}),it("accept script",function(t){f({url:e+"api/return-script",method:"POST",data:{"return-script":1},accept:"script",success:function(e,o){expect(__test__).to.be(1),window.__test__=null,t()}})})}),describe("event",function(){var o=new t;beforeEach("reset expectEvents",function(){o.reset()}),afterEach("check expectEvents",function(){o.check()}),it("should trigger success and complete",function(t){o.expect(["success","complete"]),f({url:e+"api/return-json",method:"POST",data:{"return-json-success":1},success:function(t,e){o.do("success")},complete:function(){o.do("complete"),t()}})}),it("should trigger success and complete when request the cross-domain with disabled header",function(t){o.expect(["success","complete"]),f({url:e+"api/return-json",method:"POST",data:{"cross-domain-with-disabled-header":1},header:{foo:"foo"},accept:"json",success:function(t,e){o.do("success")},complete:function(){o.do("complete"),t()}})}),it("should trigger error and complete when 500",function(t){o.expect(["error","complete"]),f({url:e+"api/500",method:"POST",accept:"json",error:function(t,e){o.do("error")},complete:function(){o.do("complete"),t()}})}),it("should trigger error and complete when 404",function(t){o.expect(["error","complete"]),f({url:e+"api/404",method:"POST",accept:"json",error:function(t,e){o.do("error")},complete:function(){o.do("complete"),t()}})}),it("should trigger abort and complete when request is aborted",function(t){o.expect(["abort","complete"]);var r=f({url:e+"api/abort",method:"POST",abort:function(){o.do("abort")},complete:function(){o.do("complete")}});setTimeout(function(){r.abort(),t()},100)}),it("calling `abort` after `complete` event should be ignored",function(t){this.timeout(5e3),o.expect(["success","complete"]);var r=f({log:!0,url:e+"api/return-json",method:"POST",success:function(){o.do("success")},complete:function(){o.do("complete")}});setTimeout(function(){r.abort(),t()},1e3)})})}),describe("./hooks",function(){describe("willFetch",function(){this.timeout(6e4),it("ajax willFetch call",function(t){var o=nattyFetch.context({urlPrefix:e,willFetch:function(){t()}});o.create({getApi:{url:"api/return-json",fit:function(t){return{success:!0,content:t}}}}),o.api.getApi().then(function(t){})}),it("jsonp willFetch call",function(t){var o=nattyFetch.context({urlPrefix:e,willFetch:function(){t()}});o.create({getApi:{url:"api/jsonp-order-create",jsonp:!0,fit:function(t){return t}}}),o.api.getApi().then(function(t){})})}),describe("didFetch",function(){it("ajax success didFetch",function(t){var o=nattyFetch.context({urlPrefix:e});o.create({getApi:{url:"api/return-json",fit:function(t){return{success:!0,content:t}},didFetch:function(e){t()}}}),o.api.getApi().then(function(t){})}),it("jsonp success didFetch long time",function(t){var o=nattyFetch.context({urlPrefix:e});o.create({getApi:{url:"api/jsonp-timeout",jsonp:!0,timeout:2e3,fit:function(t){return{success:!0,content:t}},didFetch:function(e){t()}}}),o.api.getApi().then(function(t){})}),it("ajax error didFetch",function(t){var o=nattyFetch.context({urlPrefix:e});o.create({getApi:{url:"api/return-error",fit:function(t){return t},didFetch:function(e){t()}}}),o.api.getApi().then(function(t){},function(t){})}),it("jsonp error didFetch",function(t){var o=nattyFetch.context({urlPrefix:e,jsonp:!0});o.create({getApi:{url:"api/jsonp-order-create-error",fit:function(t){return t},didFetch:function(e){t()}}}),o.api.getApi().then(function(t){},function(t){})}),it("ajax timeout should NOT fire `didFetch`",function(t){var o=nattyFetch.context({urlPrefix:e,timeout:300}),r=0;o.create({getApi:{url:"api/timeout",didFetch:function(){r++}}}),o.api.getApi().then(function(){}).catch(function(){try{expect(r).to.be(0),t()}catch(e){t(e)}})}),it("jsonp timeout should NOT fire `didFetch`",function(t){var o=nattyFetch.context({urlPrefix:e,jsonp:!0,timeout:300}),r=0;o.create({getApi:{url:"api/jsonp-timeout",didFetch:function(){r++}}}),o.api.getApi().then(function(){}).catch(function(){try{expect(r).to.be(0),t()}catch(e){t(e)}})})})}),describe("storage",function(){this.timeout(1e4);var t;beforeEach("reset",function(){t=nattyFetch.context({urlPrefix:e,mock:!1})}),it("query string is same: localStorage",function(o){var r=0;t.create("user",{getPhone:{url:e+"api/return-success",willFetch:function(t,e,o){"remote"===o&&r++},storage:{type:"localStorage",tag:"v1.0",key:"test-query-string"}}}),t.api.user.getPhone({b:1,a:1}).then(function(e){return t.api.user.getPhone({a:1,b:1})}).then(function(e){try{expect(e.id).to.be(1),expect(r).to.be(1),o()}catch(t){o(t)}t.api.user.getPhone.storage.destroy()}).catch()}),it("query string is same: sessionStorage",function(o){var r=0;t.create("user",{getPhone:{url:e+"api/return-success",willFetch:function(t,e,o){"remote"===o&&r++},storage:{type:"sessionStorage",tag:"v1.0"}}}),t.api.user.getPhone({b:1,a:1}).then(function(e){return t.api.user.getPhone({a:1,b:1})}).then(function(e){try{expect(e.id).to.be(1),expect(r).to.be(1),o()}catch(t){o(t)}t.api.user.getPhone.storage.destroy()}).catch()}),it("query string is same: variable",function(o){var r=0;t.create("user",{getPhone:{url:e+"api/return-success",willFetch:function(t,e,o){"remote"===o&&r++},storage:{type:"variable",tag:"v1.0"}}}),t.api.user.getPhone({b:1,a:1}).then(function(e){return t.api.user.getPhone({a:1,b:1})}).then(function(t){try{expect(t.id).to.be(1),expect(r).to.be(1),o()}catch(t){o(t)}}).catch()}),it("query string is same with jsonp",function(o){var r=0;t.create("user",{getPhone:{jsonp:!0,url:e+"api/jsonp-order-create",willFetch:function(t,e,o){"remote"===o&&r++},storage:{type:"localStorage",tag:"v1.0",key:"test-jsonp-with-storage"}}}),t.api.user.getPhone({b:1,a:1}).then(function(e){return t.api.user.getPhone({a:1,b:1})}).then(function(e){try{expect(e.id).to.be(1),expect(r).to.be(1),o()}catch(t){o(t)}t.api.user.getPhone.storage.destroy()}).catch()}),it("query string is different",function(o){var r=0;t.create({get:{url:e+"api/return-success",willFetch:function(t,e,o){"remote"===o&&r++},storage:!0}}),t.api.get({b:1,a:1}).then(function(){return t.api.get({a:1})}).then(function(e){try{expect(e.id).to.be(1),expect(r).to.be(2),o()}catch(t){o(t)}t.api.get.storage.destroy()}).catch()}),it("no query string",function(o){var r=0;t.create({get:{url:e+"api/return-success",willFetch:function(t,e,o){"remote"===o&&r++},storage:!0}}),t.api.get().then(function(){return t.api.get()}).then(function(e){try{expect(e.id).to.be(1),expect(r).to.be(1),o()}catch(t){o(t)}t.api.get.storage.destroy()}).catch()}),it("`POST` request with `storage` on should throw an error",function(){var o=function(){t.create({get:{url:e+"api/return-success",method:"POST",storage:!0}})};expect(o).to.throwError()})}),describe("plugin",function(){it("options.plugins should been merged, NOT overrided.",function(){var t=nattyFetch.context({urlPrefix:e,plugins:[nattyFetch.plugin.soon]});t.create({foo:{url:e+"api/return-success",plugins:[nattyFetch.plugin.loop]}}),expect(t.api.foo.soon).to.be.a("function"),expect(t.api.foo.loop).to.be.a("function")})}),describe("plugin soon",function(){it("`soon` method with `storage` is open",function(t){var o=nattyFetch.context({urlPrefix:e,mock:!1}),r=0,c=0,n=0;o.create({"foo.get":{url:e+"api/return-stamp",storage:!0,willFetch:function(t,e,o){"remote"===o&&n++},plugins:[nattyFetch.plugin.soon]}});var i,a;o.api.foo.get.soon({q:1},function(t){r++,i=t,o.api.foo.get.soon({q:1},function(t){c++,1===c&&(a=t)})},function(e){t(e)}),setTimeout(function(){try{expect(r).to.be(1),expect(c).to.be(2),expect(n).to.be(2),expect(i.fromStorage).to.be(!1),expect(a.fromStorage).to.be(!0),expect(JSON.stringify(i.content)).to.be(JSON.stringify(a.content)),o.api.foo.get.storage.destroy(),t()}catch(e){t(e)}},800)}),it("`soon` method with `storage` is closed",function(t){var o=nattyFetch.context({urlPrefix:e,mock:!1}),r=0,c=0,n=0;o.create({"foo.get":{url:e+"api/return-stamp",storage:!1,willFetch:function(t,e,o){"remote"===o&&n++},plugins:[nattyFetch.plugin.soon]}});var i,a;o.api.foo.get.soon({q:1},function(t){r++,i=t,o.api.foo.get.soon({q:1},function(t){c++,a=t})},function(e){t(e)}),setTimeout(function(){try{expect(r).to.be(1),expect(c).to.be(1),expect(n).to.be(2),expect(i.fromStorage).to.be(!1),expect(a.fromStorage).to.be(!1),expect(JSON.stringify(i.content)).not.to.be(JSON.stringify(a.content)),t()}catch(e){t(e)}},800)})}),describe("plugin loop",function(){it("loop",function(t){var o=nattyFetch.context({urlPrefix:e,mock:!1});o.create("taxi",{getDriverNum:{url:e+"api/return-success",plugins:[nattyFetch.plugin.loop]}});var r=0,c=o.api.taxi.getDriverNum.loop({data:{},duration:200},function(t){r++},function(t){});setTimeout(function(){expect(r).to.be.above(1),expect(c.looping).to.be(!0),c(),expect(c.looping).to.be(!1),t()},1e3)})}),describe.skip("plugin customRequest",function(){this.timeout(1e4),it("customRequest",function(t){var o=nattyFetch.context({urlPrefix:e,mock:!1}),r=nattyFetch._util,c=r.appendQueryString,n=r.extend,i=r.param,a=function(t){t.config.jsonp||(t.config.customRequest=function(e,o,r){var a="POST"===o.method,u={uri:a?o.url:c(o.url,n(e.mark,e.data,o.traditional)),method:o.method,headers:o.header,body:a?i(e.data,o.traditional):"",onSuccess:function(c){200==c.statusCode?t.processResponse(e,o,r,JSON.parse(c.responseText)):r.reject({statusCode:c.statusCode,message:c.statusText})},onError:function(t){r.reject(t)}};dd.internal.request.httpOverLWP(u)})};o.create({foo:{url:"http://120.26.213.24:3000/api/xhr-success",method:"POST",data:{gg:"a"},plugins:[a]},boo:{url:"http://120.26.213.24:3000/api/xhr-failed",plugins:[a]},boo500:{url:"http://120.26.213.24:3000/api/500",plugins:[a]},boo404:{url:"http://example404.com/",plugins:[a]}}),o.api.foo({hh:"a"}).then(function(e){console.log("foo"),console.log(e),t()})})});var h=function(t,e){e()};h.xonly=h,describe("nattyFetch.create",function(){this.timeout(3e4),it("play with standard data structure",function(t){var o=nattyFetch.create({urlPrefix:e,url:"api/order-create",method:"POST"});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}})}),it("play with non-standard data structure by `fit`",function(t){var o=nattyFetch.create({url:e+"api/order-create-non-standard",method:"POST",fit:function(t){return{success:!t.hasError,content:t.content}}});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}})}),it("process data",function(t){var o=nattyFetch.create({url:e+"api/order-create",method:"POST",process:function(t){return{orderId:t.id}}});o().then(function(e){try{expect(e.orderId).to.be(1),t()}catch(e){t(e)}})}),it("`vars.data` in process or fix method",function(t){var o=nattyFetch.create({url:e+"api/order-create",method:"POST",data:{liveData:1},willFetch:function(t,e){t.data.hookData=1},process:function(t,e){return expect(e.data.liveData).to.be(1),expect(e.data.hookData).to.be(1),{orderId:t.id}},fit:function(t,e){return expect(e.data.liveData).to.be(1),expect(e.data.hookData).to.be(1),t}});o().then(function(e){try{expect(e.orderId).to.be(1),t()}catch(e){t(e)}})}),it("skip process data when it is mocking ",function(t){var o=nattyFetch.create({mock:!0,mockUrl:e+"api/order-create",process:function(t){return this.mock?t:{orderId:t.id}}});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}})}),it("error by requesting cross-domain with disabled header [NOTE: IE的行为已被标准化]",function(t){var o=nattyFetch.create({url:e+"api/order-create",method:"POST",header:{foo:"foo"}});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}},function(t){})}),it("error by timeout",function(t){var o=nattyFetch.create({
url:e+"api/timeout",method:"POST",timeout:100});o().then(function(){},function(e){try{expect(e.timeout).to.be(!0),t()}catch(e){t(e)}})}),it("error by 500",function(t){var o=nattyFetch.create({url:e+"api/500",method:"POST"});o().then(function(){},function(e){try{expect(e.status).to.be(nattyFetch.ajax.fallback?void 0:500),t()}catch(e){t(e)}})}),it("error by 404",function(t){var o=nattyFetch.create({url:e+"api/404",method:"POST"});o().then(function(){}).catch(function(e){try{nattyFetch.ajax.fallback?expect(e.status).to.be(void 0):expect(0===e.status||404===e.status).to.be(!0),t()}catch(e){t(e)}})}),it("`GET` resolving after retry",function(t){var o=nattyFetch.create({url:e+"api/retry-success",method:"GET",retry:2});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}},function(){})}),it("`GET` with fn-data resolving after retry",function(t){var o=0,r=nattyFetch.create({url:e+"api/retry-success",method:"GET",retry:2,data:function(){return{count:o++}}});r().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}},function(){})}),it("`POST` resolving after retry",function(t){var o=nattyFetch.create({url:e+"api/retry-success",method:"POST",retry:2});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}},function(){})}),it("rejecting after retry",function(t){var o=nattyFetch.create({url:e+"api/return-error",retry:1});o().then(function(t){},function(e){try{expect(e.code).to.be(1),t()}catch(e){t(e)}})}),it("`ignoreSeftConcurrent` should work",function(t){var o=nattyFetch.create({cache:!1,url:e+"api/timeout",ignoreSelfConcurrent:!0});o().then(function(e){try{expect(e.id).to.be(1),t()}catch(e){t(e)}});var r=o().then(function(){throw new Error("unexpected `resolved`")});expect(r).to.have.property("dummy"),expect(r.then()).to.be(r),expect(r.then().catch()).to.be(r)}),it("`overrideSeftConcurrent` should work (XHR)",function(t){var o=nattyFetch.create({url:e+"api/timeout",data:{d:0},overrideSelfConcurrent:!0,process:function(t,e){expect(e.data.d).to.be(2)}}),r=0;o({d:1}).then(function(t){r++}),setTimeout(function(){o({d:2}).then(function(e){try{expect(r).to.be(0),t()}catch(e){t(e)}})},300)}),it("calling `abort`",function(t){var o=0,r=nattyFetch.create({url:e+"api/success"});r().then(function(){o++}),expect(r.pending).to.be(!0),r.abort(),setTimeout(function(){try{expect(o).to.be(0),expect(r.pending).to.be(!1),t()}catch(e){t(e)}},300)})});var d=function(t,e){e()};d.xonly=d;var l=function(){},b=function(t){t(l,l)};b.prototype.then=function(){return this},b.prototype.catch=function(){return this},b.prototype.finally=function(){return this},describe("use private `Promise` object",function(){this.timeout(3e4),it("MyPromise instance should have `finally` method",function(){var t=nattyFetch.create({urlPrefix:e,url:"api/order-create",method:"POST",Promise:b});expect(t().finally).to.be.a("function")}),it("origin Promise instance dose NOT have `finally` method",function(){var t=nattyFetch.create({urlPrefix:e,url:"api/order-create",method:"POST"});expect(t().finally).to.be(void 0)}),it("set RSVP Promise on context",function(){var t=nattyFetch.context({Promise:b});t.create({fooFetch:{urlPrefix:e,url:"api/order-create",method:"POST"}}),expect(t.api.fooFetch().finally).to.be.a("function")})})}();
//# sourceMappingURL=bundle.js.map
